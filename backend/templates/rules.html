{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">Rules</h2>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Run Labeler</span>
    <div>
      <button class="btn btn-sm btn-outline-primary" id="init-default-labels-btn">
        Init Default @LL Labels
      </button>
      <button class="btn btn-sm btn-primary" id="run-labeler-btn">
        Run Now
      </button>
    </div>
  </div>
  <div class="card-body">
    <div id="init-labels-status" class="mb-2 small text-muted"></div>
    <div id="run-labeler-status" class="small text-muted"></div>
    <div class="mt-2">
      <a id="download-run-log-link" href="/download-run-log" class="small" target="_blank" rel="noopener">
        Download last run log
      </a>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Labels &amp; Unread Counts</span>
    <button class="btn btn-sm btn-outline-secondary" id="refresh-labels-btn">
      Refresh Labels
    </button>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Label</th>
            <th class="text-end">Unread</th>
            <th class="text-end">Total</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="labels-table-body">
          <tr><td colspan="4" class="text-muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
    <div id="labels-status" class="small text-muted"></div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Create / Update Rule</span>
    <button class="btn btn-sm btn-outline-secondary" id="clear-btn">Clear</button>
  </div>

  <div class="card-body">
    <form id="rule-form" class="mb-2">
      <div class="mb-2">
        <label class="form-label">Label Name</label>
        <input class="form-control" id="label-name" placeholder="@LL-Finance" required />
      </div>

      <div class="mb-2">
        <label class="form-label">From contains</label>
        <input class="form-control" id="from-contains" placeholder="example.com" />
      </div>

      <div class="mb-2">
        <label class="form-label">Subject contains</label>
        <input class="form-control" id="subject-contains" placeholder="invoice" />
      </div>

      <div class="mb-2">
        <label class="form-label">Body contains</label>
        <input class="form-control" id="body-contains" placeholder="payment due" />
      </div>

      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="is-active" checked />
        <label class="form-check-label" for="is-active">Active</label>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="mark-as-read" />
        <label class="form-check-label" for="mark-as-read">Mark as read when rule matches</label>
      </div>

      <button class="btn btn-primary" type="submit">Save Rule</button>
    </form>

    <div id="rule-status" class="small text-muted"></div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Existing Rules</span>
    <div>
      <button class="btn btn-sm btn-outline-secondary" id="refresh-rules-btn">Refresh</button>
      <button class="btn btn-sm btn-outline-primary" id="learn-rules-btn">Learn Rules</button>
    </div>
  </div>
  <div class="card-body">
    <div id="learn-status" class="small text-muted mb-2"></div>
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Label</th>
            <th>From</th>
            <th>Subject</th>
            <th>Body</th>
            <th>Active</th>
            <th>Mark Read</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="rules-table-body">
          <tr><td colspan="8" class="text-muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='rules.js') }}"></script>
{% endblock %}
